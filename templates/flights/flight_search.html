{% extends 'base.html' %}
{% load static %}

{% block title %}Find Your Flight{% endblock title %}

{% block content %}
<div class="container mx-auto mt-8 px-4 mb-12">

    <!-- Search Form Card -->
    <div class="max-w-2xl mx-auto bg-[#1e293b] p-8 rounded-2xl shadow-2xl border border-gray-700">
        <div class="text-center mb-6">
            <h1 class="text-4xl font-bold text-white tracking-tight">Find Your Perfect Flight</h1>
            <p class="text-slate-400 mt-2">Discover the best deals for your next journey.</p>
        </div>

        <form method="GET" action="{% url 'flights:flight_search' %}" id="flight-search-form">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">


                <div>
                    <label for="fly_from" class="block text-sm font-medium text-slate-300 mb-1">From</label>
                    <input type="text" name="fly_from" id="fly_from" value="{{ search_params.fly_from }}" required placeholder="e.g., TAS"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                           maxlength="3" style="text-transform: uppercase;">
                </div>


                <div>
                    <label for="fly_to" class="block text-sm font-medium text-slate-300 mb-1">To</label>
                    <input type="text" name="fly_to" id="fly_to" value="{{ search_params.fly_to }}" required placeholder="e.g., JFK"
                           class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                           maxlength="3" style="text-transform: uppercase;">
                </div>
            </div>

            <!-- Departure Date -->
            <div class="mt-6">
                <label for="date_from" class="block text-sm font-medium text-slate-300 mb-1">Departure Date</label>
                <input type="date" name="date_from" id="date_from" value="{{ search_params.date_from }}" required
                       class="w-full px-4 py-3 bg-slate-800 border border-slate-600 rounded-lg text-white" style="color-scheme: dark;">
            </div>

            <!-- Search Button with Spinner -->
            <div class="mt-6">
                <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-400 hover:to-blue-500 text-white font-bold py-3 rounded-lg transition-all duration-300 shadow-lg" id="search-button">
                    Search Flights
                </button>
                <div class="w-full bg-slate-700 text-white font-bold py-3 rounded-lg text-center hidden" id="loading-spinner">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Searching...
                </div>
            </div>
        </form>

        <p class="text-xs text-gray-500 text-center mt-4">
            Please use 3-letter IATA airport codes (e.g., Tashkent -> TAS).
        </p>
    </div>

    <!-- Search Results Section -->
    <div class="max-w-4xl mx-auto mt-12">
        {% if flights %}
            <!-- === NATIJALAR SARLAVHASI TO'G'RILANDI === -->
            <h2 class="text-2xl font-semibold text-white mb-6">Results for <span class="text-cyan-400">{{ search_params.fly_from }}</span> to <span class="text-cyan-400">{{ search_params.fly_to }}</span></h2>
            <div class="space-y-4">
            {% for flight in flights %}
                <div class="bg-slate-800 rounded-lg p-5 flex flex-col md:flex-row justify-between items-center gap-6 border border-slate-700 transition-all hover:shadow-lg hover:border-cyan-500/50">
                    <!-- Flight Info -->
                    <div class="flex-grow text-center md:text-left">
                        <p class="text-lg font-bold text-white">{{ flight.airlines|join:", " }}</p>
                        <div class="flex flex-col md:flex-row md:items-center gap-x-6 text-sm text-slate-400 mt-2">
                            <span><strong>Departure:</strong> {{ flight.departure_time|date:"Y-m-d, H:i" }}</span>
                            <span><strong>Arrival:</strong> {{ flight.arrival_time|date:"Y-m-d, H:i" }}</span>
                            <span><strong>Duration:</strong> {{ flight.duration }}</span>
                        </div>
                    </div>
                    <!-- Price and Booking -->
                    <div class="text-center border-t md:border-t-0 md:border-l border-slate-700 pt-4 md:pt-0 md:pl-6">
                        <p class="text-3xl font-bold text-cyan-400">${{ flight.price }}</p>
                        <a href="{{ flight.deep_link }}" target="_blank" rel="noopener noreferrer"
                           class="mt-2 inline-block bg-green-600 hover:bg-green-500 text-white text-sm font-semibold px-6 py-2 rounded-full transition-colors">
                           Book Now
                        </a>
                    </div>
                </div>
            {% endfor %}
            </div>
        {% elif error %}
            <div class="bg-red-900/50 border border-red-700 text-red-300 p-6 rounded-lg text-center max-w-2xl mx-auto">
                <p class="text-xl font-semibold">An error occurred</p>
                <p class="mt-2">{{ error }}</p>
            </div>
        {% elif no_results %}
             <div class="bg-slate-800 p-8 rounded-lg text-center max-w-2xl mx-auto">
                <p class="text-xl font-semibold text-white">{{ no_results }}</p>
                <p class="text-slate-400 mt-2">Try searching for a different date or IATA code.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock content %}

{% block javascript %}
<script>
    const searchForm = document.getElementById('flight-search-form');
    const searchButton = document.getElementById('search-button');
    const loadingSpinner = document.getElementById('loading-spinner');

    if (searchForm) {
        searchForm.addEventListener('submit', function() {
            if (searchForm.checkValidity()) {
                if (searchButton && loadingSpinner) {
                    searchButton.classList.add('hidden');
                    loadingSpinner.classList.remove('hidden');
                }
            }
        });
    }
</script>
{% endblock javascript %}